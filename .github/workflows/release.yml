name: Release to PyPI

on:
  push:
    branches:
      - main  # Adjust if your default branch is different
    paths:
      - 'pyproject.toml'

permissions:
  id-token: write  # Required for OIDC authentication
  contents: read


jobs:
  release:
    name: ğŸ¯ Create Release & Publish to PyPI
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ›ï¸ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: ğŸ“¦ Install dependencies
        run: pip install toml build

      - name: ğŸ” Extract version from pyproject.toml
        id: get_version
        run: |
          VERSION=$(python -c "import toml; print(toml.load('pyproject.toml')['tool']['poetry']['version'])")
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "ğŸ”¢ Version extracted: $VERSION"

      - name: ğŸ” Check if Git tag exists
        id: check_tag
        run: |
          if git rev-parse "v${VERSION}" >/dev/null 2>&1; then
            echo "âš ï¸ Tag v${VERSION} already exists. Skipping release!"
            exit 1
          fi

      - name: "ğŸ—ï¸ Get previous release version"
        id: last_release
        uses: InsonusK/get-latest-release@v1.1.0
        with:
          myToken: ${{ github.token }}
          exclude_types: "draft|prerelease"

      - name: ğŸ·ï¸ Create and push Git tag
        run: |
          git tag v${VERSION}
          git push origin v${VERSION}
          echo "âœ… Tag v${VERSION} created and pushed!"

      - name: "ğŸ—’ï¸ Generate release changelog"
        id: changelog
        uses: heinrichreimer/github-changelog-generator-action@v2.3
        with:
          token: ${{ secrets.GITHUB_TOKEN }} 
          sinceTag: ${{ steps.last_release.outputs.tag_name }}
          headerLabel: "# Notable changes since ${{ steps.last_release.outputs.tag_name }}"
          stripGeneratorNotice: true


      - name: ğŸš€ Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ env.VERSION }}
          name: ğŸ‰ Release v${{ env.VERSION }}
          body: "ğŸš€ Automated release of version **v${{ env.VERSION }}**"
          draft: false
          prerelease: false

      - name: ğŸ—ï¸ Build package
        run: python -m build

      - name: ğŸ—ï¸ Build package
        run: |
          python setup.py sdist bdist_wheel
          echo "ğŸ“¦ Package built successfully!"

      - name: ğŸš€ Publish to PyPI with OpenID
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          # No API token needed! OpenID handles authentication.
          repository-url: https://upload.pypi.org/legacy/



