name: Release to PyPI

on:
  push:
    branches:
      - main  # Adjust if your default branch is different
    paths:
      - 'pyproject.toml'

permissions:
  id-token: write  # Required for OIDC authentication
  contents: write


jobs:
  release:
    name: ğŸ¯ Create Release & Publish to PyPI
    runs-on: ubuntu-latest
    if: github.repository_owner == 'Olen'  # Make sure this is not a fork

    steps:
      - name: ğŸ›ï¸ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Requried to check if a tag exists already

      - name: ğŸ Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.x'

      - name: ğŸ­ Install Poetry
        uses: snok/install-poetry@v1
        with:
          virtualenvs-create: true
          virtualenvs-in-project: true

      - name: ğŸ—ï¸ Install project
        run: poetry install

      - name: ğŸ” Extract version from Poetry
        id: get_version
        run: |
          VERSION=$(poetry version -s)
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "ğŸ”¢ Extracted version: $VERSION"

      - name: ğŸ” Check if Git tag exists
        id: check_tag
        run: |
          if git rev-parse "v${VERSION}" >/dev/null 2>&1; then
            echo "âš ï¸ Tag v${VERSION} already exists. Skipping release!"
            exit 1
          fi

      - name: "ğŸ—ï¸ Get previous release version"
        id: last_release
        uses: InsonusK/get-latest-release@v1.1.0
        with:
          myToken: ${{ github.token }}
          exclude_types: "draft|prerelease"

      - name: "ğŸ·ï¸ Create new tag"
        uses: rickstaa/action-create-tag@v1
        id: "tag_create"
        with:
          tag: "v${{ env.VERSION }}"
          tag_exists_error: false
          message: "âœ… Tag Version v${{ env.VERSION }} created"

      - name: "ğŸ—’ï¸ Generate release changelog"
        id: changelog
        uses: heinrichreimer/github-changelog-generator-action@v2.4
        with:
          token: ${{ secrets.GITHUB_TOKEN }} 
          sinceTag: ${{ steps.last_release.outputs.tag_name }}
          headerLabel: "# Notable changes since ${{ steps.last_release.outputs.tag_name }}"
          stripGeneratorNotice: true

      - name: ğŸš€ Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ env.VERSION }}
          name: ğŸ‰ Release v${{ env.VERSION }}
          body: "${{ steps.changelog.outputs.changelog }}"
          draft: false
          prerelease: false

      - name: ğŸ—ï¸ Build package with Poetry
        run: poetry build

      - name: ğŸš€ Publish to PyPI with OpenID
        uses: pypa/gh-action-pypi-publish@release/v1

